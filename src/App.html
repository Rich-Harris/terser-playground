<div class="playground">
	<textarea class="input" bind:value=input></textarea>
	<textarea class="output" class:error readonly value={error ? error.message : code}></textarea>
</div>

<style>
	.playground {
		width: 100%;
		height: 100%;
		display: grid;
		grid-template-columns: 1fr 1fr;
		grid-gap: 0.5em;
	}

	textarea {
		resize: none;
		font-family: 'Courier New', Courier, monospace;
		margin: 0;
	}

	.output {
		background-color: #f9f9f9;
	}

	.error {
		background-color: rgb(255,240,240);
		border: 1px solid rgb(255,200,200);
		color: red;
	}
</style>

<script>
	export default {
		data() {
			return {
				input: 'const answer = 42;',
				code: ''
			};
		},

		oncreate() {
			const worker = new Worker('worker.js');

			const callbacks = {};
			let uid = 1;
			let current_token;

			const minify = () => {
				const { input } = this.get();
				const token = uid++;
				worker.postMessage({ input, token });
			};

			worker.addEventListener('message', event => {
				if (event.data.ready) {
					this.set({ ready: true });
					minify();
				}

				else if (event.data.token === current_token) {
					this.set({
						code: event.data.code,
						warnings: event.data.warnings,
						error: event.data.error
					});
				}
			});

			this.on('state', async ({ changed, current }) => {
				if (changed.input) minify();
			});
		}
	};
</script>